<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holistic Dynamics Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Style for the file input button */
        input[type="file"] {
            display: none;
        }
        /* Ensure responsive tables */
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            min-width: 600px; /* Prevent squishing on small screens */
        }
         /* Simple toast notification styling */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2dd4bf;
            color: #111827;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            font-weight: 500;
        }
        .toast.show {
            opacity: 1;
            transform: translate(-50%, -10px);
        }
        /* Custom checkbox style */
        .custom-checkbox {
            appearance: none;
            background-color: #374151;
            border: 1px solid #6b7280;
            border-radius: 4px;
            width: 1.5rem;
            height: 1.5rem;
            cursor: pointer;
            position: relative;
            display: inline-block;
            vertical-align: middle;
        }
        .custom-checkbox:checked {
            background-color: #14b8a6;
            border-color: #0d9488;
        }
        .custom-checkbox:checked::after {
            content: 'âœ”';
            position: absolute;
            color: white;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1rem;
        }
    </style>
</head>
<body class="h-full text-gray-200 p-2 sm:p-4 md:p-6 lg:p-8 bg-gray-900">
    <div id="app" class="max-w-7xl mx-auto flex flex-col h-full">
        <!-- Header Section -->
        <header class="bg-gray-800 rounded-lg p-4 mb-4 shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <h1 class="text-2xl font-bold text-teal-400">Holistic Dynamics Log</h1>
                <!-- Player Selection -->
                <div class="flex flex-wrap items-center gap-2">
                    <select id="player-select" class="bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:outline-none w-full md:w-auto"></select>
                </div>
            </div>
            
            <div id="pdf-content">
                <!-- Player Details Section -->
                 <div id="player-details-section" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 mt-4 border-t border-gray-700 pt-4">
                    <div>
                        <label for="log-date" class="block text-sm font-medium text-gray-400">Date</label>
                        <input type="date" id="log-date" class="player-detail-input mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full focus:ring-2 focus:ring-teal-500 focus:outline-none">
                    </div>
                     <div>
                        <label for="player-dob" class="block text-sm font-medium text-gray-400">D.O.B.</label>
                        <input type="date" id="player-dob" class="player-detail-input mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full focus:ring-2 focus:ring-teal-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400">Age</label>
                        <span id="player-age" class="mt-1 flex items-center bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white w-full h-10"></span>
                    </div>
                    <div>
                        <label for="player-position" class="block text-sm font-medium text-gray-400">Position</label>
                        <input type="text" id="player-position" placeholder="e.g., Forward" class="player-detail-input mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full focus:ring-2 focus:ring-teal-500 focus:outline-none">
                    </div>
                     <div>
                        <label for="player-shirt-nr" class="block text-sm font-medium text-gray-400">Shirt Nr.</label>
                        <input type="number" id="player-shirt-nr" placeholder="e.g., 10" class="player-detail-input mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full focus:ring-2 focus:ring-teal-500 focus:outline-none">
                    </div>
                </div>
            </div>

            <!-- Add Player Section -->
            <div class="flex flex-col sm:flex-row items-end gap-2 mt-4 border-t border-gray-700 pt-4">
                 <div class="flex-grow">
                     <label for="player-name-input" class="block text-sm font-medium text-gray-400">New Player Name</label>
                     <input id="player-name-input" type="text" placeholder="Enter new player name..." class="mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:outline-none w-full">
                 </div>
                 <button id="add-player-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 w-full sm:w-auto">Add Player</button>
                 <button id="delete-player-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 w-full sm:w-auto">Delete Active Player</button>
            </div>

             <!-- Action Buttons -->
            <div class="flex flex-wrap gap-2 mt-4 border-t border-gray-700 pt-4">
                <button id="reset-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 flex-1 sm:flex-grow-0">Clear Form</button>
                <button id="export-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 flex-1 sm:flex-grow-0">Export JSON</button>
                <label for="import-file" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 cursor-pointer flex-1 sm:flex-grow-0 text-center">Import JSON</label>
                <input type="file" id="import-file" accept=".json">
                <button id="pdf-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 flex-1 sm:flex-grow-0">Save as PDF</button>
            </div>
        </header>

        <!-- Main Content: Log Form -->
        <main class="flex-grow bg-gray-800 rounded-lg p-4 overflow-y-auto shadow-inner" id="log-form">
            <form id="dynamics-form" onsubmit="return false;">
                <!-- Log Sections will be dynamically inserted here -->
            </form>
        </main>
        
        <!-- Toast Notification -->
        <div id="toast" class="toast"></div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const playerSelect = document.getElementById('player-select');
            const playerNameInput = document.getElementById('player-name-input');
            const addPlayerBtn = document.getElementById('add-player-btn');
            const deletePlayerBtn = document.getElementById('delete-player-btn');
            const resetBtn = document.getElementById('reset-btn');
            const exportBtn = document.getElementById('export-btn');
            const importFile = document.getElementById('import-file');
            const pdfBtn = document.getElementById('pdf-btn');
            const logFormContainer = document.getElementById('dynamics-form');
            const toastElement = document.getElementById('toast');
            const logDateInput = document.getElementById('log-date');
            const playerPositionInput = document.getElementById('player-position');
            const playerShirtNrInput = document.getElementById('player-shirt-nr');
            const playerDobInput = document.getElementById('player-dob');
            const playerAgeSpan = document.getElementById('player-age');
            const playerDetailsSection = document.getElementById('player-details-section');

            // Application State
            let players = [];
            let activePlayerId = null;

            // Log Structure Definition
            const logStructure = [
                {
                    title: "SECTION 1: FOUNDATIONAL READINESS",
                    description: "This section is the foundation. It tells you if the athlete is physically and mentally prepared to train effectively before they even start.",
                    params: [
                        { id: 'sleep', label: 'Athlete-Reported Sleep', options: ['Optimal (8+ hrs)', 'Sufficient (7-8 hrs)', 'Compromised (<7 hrs)'] },
                        { id: 'readiness', label: 'Physiological Readiness', options: ['High', 'Moderate', 'Low'] },
                        { id: 'punctuality', label: 'Morning Punctuality', options: ['Proactive', 'Standard', 'Reactive'] },
                        { id: 'protocols', label: 'Adherence to Protocols', options: ['Diligent', 'Compliant', 'Avoidant'] }
                    ]
                },
                {
                    title: "SECTION 2: PSYCHOLOGICAL & BEHAVIORAL PROFILE",
                    description: "This section is the athleteâ€™s 'Operating System.' It reveals their default tendencies under pressure.",
                    params: [
                        { id: 'motivation', label: 'Primary Motivational Driver', options: ['Towards Pleasure', 'Away From Pain'] },
                        { id: 'validation', label: 'Source of Validation', options: ['Internal', 'External'] },
                        { id: 'processing', label: 'Information Processing Style', options: ["Global (The 'Why')", "Detail (The 'How')"] },
                        { id: 'change', label: 'Response to Change & Novelty', options: ['Prefers Sameness', 'Energized by Difference'] },
                        { id: 'social', label: 'Primary Social Orientation', options: ['Independent', 'Co-operative'] }
                    ]
                },
                 {
                    title: "SECTION 3: TRAINING & PERFORMANCE DYNAMICS",
                    description: "This is the core of the observation. It logs how the athlete behaves within the training environment itself.",
                    params: [
                        { id: 'context', label: 'Context of Observation', options: ['Low-Pressure', 'Moderate-Pressure', 'High-Pressure'] },
                        { id: 'focus', label: 'Focus & Activation', options: ['Proactive', 'Standard', 'Distracted'] },
                        { id: 'errorResponse', label: 'Reaction to Error/Setback', options: ['Resilient', 'Emotional (Internal)', 'Emotional (External)'] },
                        { id: 'perseverance', label: 'Perseverance Under Fatigue', options: ['High & Consistent Effort', 'Fluctuating Effort', 'Gives Up / Avoids'] },
                        { id: 'interaction', label: 'Coach/Teammate Interaction', options: ['Positive Connector', 'Task-Focused', 'Negative/Agitated'] },
                        { id: 'language', label: 'Observed Dominant Language', options: ['Possibility-Focused', 'Problem-Focused'] }
                    ]
                },
                {
                    title: "SECTION 4: MATCH DAY PRESSURE RESPONSE (Optional)",
                    description: "This optional section assesses how the athlete handles the unique stress of competition.",
                    params: [
                         { id: 'preCompState', label: 'Pre-Competition State', options: ['Optimal Fighter', 'Anxious/Hyper-activated', 'Apathetic/Withdrawn'] },
                         { id: 'pressureResponse', label: 'Response to High-Pressure', options: ['Thrives', 'Copes', 'Hides/Panics'] },
                         { id: 'setbackBodyLanguage', label: 'Body Language After Setback', options: ['Resilient', 'Defeated', 'Agitated'] },
                         { id: 'postMatchReaction', label: 'Post-Match Reaction', options: ['Balanced', 'Highly Emotional', 'Destructive/Blaming'] }
                    ]
                },
                {
                    title: "SECTION 5: MENTAL SKILLS & SESSIONS TO DO LIST",
                    description: "Track and score the implementation of key mental skills and intervention sessions.",
                    type: 'mental_skills', // Special type for custom rendering
                    params: [
                        { id: 'selfTalk', label: 'Positive Self Talk' },
                        { id: 'negativeSelfTalk', label: 'Negative Self Talk' },
                        { id: 'emotionalAnchor', label: 'Emotional Anchor' },
                        { id: 'emotionalControl', label: 'Emotional Control' },
                        { id: 'visualisation', label: 'Visualisation' },
                        { id: 'goalSetting', label: 'Goal Setting' },
                        { id: 'stressControl', label: 'Stress Control' },
                        { id: 'selfAwareness', label: 'Self Awareness' },
                        { id: 'strengthCorrections', label: 'Strength & Corrections' },
                        { id: 'breathing', label: 'Breathing Techniques' },
                        { id: 'focus', label: 'How to Focus' },
                        { id: 'individualSessions', label: 'Individual Sessions' },
                        { id: 'crisisTalks', label: 'Crisis Talks' },
                        { id: 'newBehavior', label: 'New Behavior Pattern' },
                        { id: 'patternInterrupt', label: 'Pattern Interrupt' }
                    ]
                }
            ];

            // --- Utility Functions ---

            const showToast = (message) => {
                toastElement.textContent = message;
                toastElement.classList.add('show');
                setTimeout(() => {
                    toastElement.classList.remove('show');
                }, 3000);
            };

            const calculateAge = (dobString) => {
                if (!dobString) return '';
                const dob = new Date(dobString);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                return age;
            };

            const generateNewLogData = () => {
                const data = {
                    logDate: new Date().toISOString().split('T')[0] // Default to today's date
                };
                logStructure.forEach(section => {
                    if (section.type === 'mental_skills') {
                        data.mentalSkills = {}; // Use a dedicated object for this section
                        section.params.forEach(param => {
                            data.mentalSkills[param.id] = { checked: false, score: '', comment: '' };
                        });
                    } else {
                        if (!data['comments']) {
                            data['comments'] = {};
                        }
                        section.params.forEach(param => {
                            data[param.id] = '';
                            data['comments'][param.id] = '';
                        });
                    }
                });
                return data;
            };


            // --- Data Persistence ---

            const saveData = () => {
                try {
                    localStorage.setItem('dynamicsLogPlayers', JSON.stringify(players));
                    localStorage.setItem('dynamicsLogActivePlayer', activePlayerId);
                    localStorage.setItem('dynamicsLogStructure', JSON.stringify(logStructure));
                } catch (e) {
                    console.error("Failed to save data to localStorage", e);
                    showToast("Error: Could not save data.");
                }
            };

            const loadData = () => {
                try {
                    const savedPlayers = localStorage.getItem('dynamicsLogPlayers');
                    const savedActivePlayer = localStorage.getItem('dynamicsLogActivePlayer');
                    const savedStructure = localStorage.getItem('dynamicsLogStructure');

                    if (savedStructure) {
                        const loadedStructure = JSON.parse(savedStructure);
                        if (Array.isArray(loadedStructure) && loadedStructure.length > 0) {
                           Object.assign(logStructure, loadedStructure);
                        }
                    }

                    if (savedPlayers) {
                        players = JSON.parse(savedPlayers);
                    }
                    if (savedActivePlayer) {
                        activePlayerId = savedActivePlayer;
                    }
                } catch (e) {
                    console.error("Failed to load data from localStorage", e);
                    players = [];
                    activePlayerId = null;
                    showToast("Error: Could not load saved data.");
                }
            };
            
            // --- UI Rendering ---

            const renderLogForm = () => {
                let html = '';
                logStructure.forEach(section => {
                    html += `
                        <fieldset class="mb-6 border-t-2 border-teal-500 pt-2">
                            <legend class="text-xl font-semibold text-teal-400 mb-2 px-2">${section.title}</legend>
                            <p class="text-sm text-gray-400 mb-4 px-2">${section.description}</p>
                            <div class="table-container">
                    `;
                    if (section.type === 'mental_skills') {
                        html += `
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="bg-gray-700/50">
                                        <tr>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">SESSIONS</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider text-center">RE-DO</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">SCORE (1-10)</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">COMMENTS</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ACTIONS</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-gray-800 divide-y divide-gray-700">
                                        ${section.params.map(param => `
                                            <tr>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${param.label}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-center">
                                                    <input type="checkbox" data-id="${param.id}" data-subtype="checked" class="log-input custom-checkbox">
                                                </td>
                                                <td class="px-4 py-4 whitespace-nowrap">
                                                    <select data-id="${param.id}" data-subtype="score" class="log-input bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full focus:ring-2 focus:ring-teal-500 focus:outline-none">
                                                        <option value="">N/A</option>
                                                        ${[...Array(10).keys()].map(i => `<option value="${i + 1}">${i + 1}</option>`).join('')}
                                                    </select>
                                                </td>
                                                <td class="px-4 py-4">
                                                    <textarea data-id="${param.id}" data-subtype="comment" class="log-input bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full h-16 resize-y focus:ring-2 focus:ring-teal-500 focus:outline-none" placeholder="Comments..."></textarea>
                                                </td>
                                                <td class="px-4 py-4 text-center">
                                                    ${param.isCustom ? `<button type="button" class="delete-session-btn text-red-500 hover:text-red-400 font-bold text-xl" data-id="${param.id}">&times;</button>` : ''}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <!-- ADD NEW SESSION UI -->
                                <div class="mt-4 p-4 border-t border-gray-700 flex flex-col sm:flex-row gap-2">
                                    <input id="new-session-input" type="text" placeholder="New session name..." class="bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:outline-none flex-grow">
                                    <button id="add-session-btn" type="button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">Add New Session</button>
                                </div>
                                `;
                    } else {
                        html += `
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="bg-gray-700/50">
                                        <tr>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Parameter</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Observation / Selection</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">COMMENTS</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-gray-800 divide-y divide-gray-700">
                                        ${section.params.map(param => `
                                            <tr>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${param.label}</td>
                                                <td class="px-4 py-4 whitespace-nowrap">
                                                    <select data-id="${param.id}" class="log-input bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full focus:ring-2 focus:ring-teal-500 focus:outline-none">
                                                        <option value="">-- Select --</option>
                                                        ${param.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                                    </select>
                                                </td>
                                                <td class="px-4 py-4">
                                                    <textarea data-id="${param.id}" data-type="comment" class="log-input bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full h-16 resize-y focus:ring-2 focus:ring-teal-500 focus:outline-none" placeholder="Comments..."></textarea>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>`;
                    }
                     html += `</div></fieldset>`;
                });
                logFormContainer.innerHTML = html;
                document.getElementById('add-session-btn')?.addEventListener('click', handleAddSession);
                logFormContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-session-btn')) {
                        handleDeleteSession(e.target.dataset.id);
                    }
                });
            };

            const updatePlayerDropdown = () => {
                playerSelect.innerHTML = '<option value="">-- Select a Player --</option>';
                players.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.name} ${p.shirtNumber ? `(#${p.shirtNumber})` : ''}`;
                    if (p.id === activePlayerId) {
                        option.selected = true;
                    }
                    playerSelect.appendChild(option);
                });
                playerDetailsSection.style.display = activePlayerId ? 'grid' : 'none';
            };

            const populateForm = (playerId) => {
                const player = players.find(p => p.id === playerId);
                if (!player) {
                    clearForm();
                    return;
                }
                
                // Populate player details
                logDateInput.value = player.data.logDate || new Date().toISOString().split('T')[0];
                playerPositionInput.value = player.position || '';
                playerShirtNrInput.value = player.shirtNumber || '';
                playerDobInput.value = player.dob || '';
                playerAgeSpan.textContent = calculateAge(player.dob);

                // Populate log data
                document.querySelectorAll('.log-input').forEach(input => {
                    const dataId = input.dataset.id;
                    const subtype = input.dataset.subtype;

                    if (subtype) { // This is a mental skills input
                        if(player.data.mentalSkills && player.data.mentalSkills[dataId]) {
                             if (subtype === 'checked') {
                                input.checked = player.data.mentalSkills[dataId].checked || false;
                            } else {
                                input.value = player.data.mentalSkills[dataId][subtype] || '';
                            }
                        } else { // Clear if no data
                            if (subtype === 'checked') input.checked = false; else input.value = '';
                        }
                    } else if (input.dataset.type === 'comment') {
                        if (player.data.comments) {
                           input.value = player.data.comments[dataId] || '';
                        } else {
                            input.value = '';
                        }
                    } else {
                        input.value = player.data[dataId] || '';
                    }
                });
            };

            const clearForm = () => {
                document.getElementById('dynamics-form').reset();
                logDateInput.value = new Date().toISOString().split('T')[0];
                playerPositionInput.value = '';
                playerShirtNrInput.value = '';
                playerDobInput.value = '';
                playerAgeSpan.textContent = '';
                if (!activePlayerId) {
                    playerDetailsSection.style.display = 'none';
                }
            };

            // --- Event Handlers ---

            const handleAddPlayer = () => {
                const name = playerNameInput.value.trim();
                if (!name) {
                    showToast("Please enter a player name.");
                    return;
                }
                if (players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                    showToast("A player with this name already exists.");
                    return;
                }
                const newPlayer = {
                    id: `player_${Date.now()}`,
                    name: name,
                    position: '',
                    shirtNumber: '',
                    dob: '',
                    data: generateNewLogData()
                };
                players.push(newPlayer);
                activePlayerId = newPlayer.id;
                playerNameInput.value = '';
                
                updateAndSave();
                showToast(`Player "${name}" added.`);
            };

            const handleDeletePlayer = () => {
                if (!activePlayerId) {
                    showToast("No player selected to delete.");
                    return;
                }
                const playerIndex = players.findIndex(p => p.id === activePlayerId);
                if (playerIndex > -1) {
                    const modalConfirm = confirm(`Are you sure you want to delete player: ${players[playerIndex].name}? This cannot be undone.`);
                    if (modalConfirm) {
                        const playerName = players[playerIndex].name;
                        players.splice(playerIndex, 1);
                        activePlayerId = players.length > 0 ? players[0].id : null;
                        
                        updateAndSave();
                        showToast(`Player "${playerName}" deleted.`);
                    }
                }
            };
            
            const handlePlayerSelect = (e) => {
                activePlayerId = e.target.value;
                if(activePlayerId) {
                    populateForm(activePlayerId);
                } else {
                    clearForm();
                }
                updatePlayerDropdown(); // To show/hide details section
                saveData();
            };

            const handleFormInput = (e) => {
                if (!activePlayerId) return;
                
                const player = players.find(p => p.id === activePlayerId);
                if (!player) return;
                
                // Handle player detail inputs separately
                if(e.target.classList.contains('player-detail-input')) {
                    if (e.target.id === 'log-date') player.data.logDate = e.target.value;
                    if (e.target.id === 'player-position') player.position = e.target.value;
                    if (e.target.id === 'player-shirt-nr') {
                        player.shirtNumber = e.target.value;
                        updatePlayerDropdown(); // Update dropdown text live
                    }
                    if(e.target.id === 'player-dob'){
                        player.dob = e.target.value;
                        playerAgeSpan.textContent = calculateAge(player.dob);
                    }
                    saveData();
                    return;
                }

                const dataId = e.target.dataset.id;
                const subtype = e.target.dataset.subtype;

                if (subtype) { // Mental skills input
                    if (!player.data.mentalSkills) player.data.mentalSkills = {};
                    if (!player.data.mentalSkills[dataId]) {
                        player.data.mentalSkills[dataId] = { checked: false, score: '', comment: '' };
                    }
                    if(subtype === 'checked') {
                        player.data.mentalSkills[dataId][subtype] = e.target.checked;
                    } else {
                        player.data.mentalSkills[dataId][subtype] = e.target.value;
                    }
                } else if (e.target.dataset.type === 'comment') {
                    if (!player.data.comments) {
                        player.data.comments = {};
                    }
                    player.data.comments[dataId] = e.target.value;
                } else {
                    player.data[dataId] = e.target.value;
                }
                saveData();
            };

            const handleAddSession = () => {
                const newSessionInput = document.getElementById('new-session-input');
                const sessionName = newSessionInput.value.trim();
                if (!sessionName) {
                    showToast("Please enter a name for the new session.");
                    return;
                }

                const sessionId = sessionName.toLowerCase().replace(/\s+/g, '_') + `_${Date.now()}`;
                
                const mentalSkillsSection = logStructure.find(s => s.type === 'mental_skills');
                if (mentalSkillsSection.params.some(p => p.label.toLowerCase() === sessionName.toLowerCase())) {
                    showToast("This session already exists.");
                    return;
                }

                mentalSkillsSection.params.push({ id: sessionId, label: sessionName, isCustom: true });
                
                players.forEach(player => {
                    if (!player.data.mentalSkills) player.data.mentalSkills = {};
                    player.data.mentalSkills[sessionId] = { checked: false, score: '', comment: '' };
                });

                newSessionInput.value = '';
                renderLogForm();
                populateForm(activePlayerId);
                saveData();
                showToast(`Session "${sessionName}" added.`);
            };
            
            const handleDeleteSession = (sessionId) => {
                if (!sessionId) return;
                
                const mentalSkillsSection = logStructure.find(s => s.type === 'mental_skills');
                const sessionIndex = mentalSkillsSection.params.findIndex(p => p.id === sessionId);
                
                if (sessionIndex > -1) {
                    const sessionName = mentalSkillsSection.params[sessionIndex].label;
                    if(confirm(`Are you sure you want to permanently delete the session "${sessionName}" for all players?`)){
                        // Remove from structure
                        mentalSkillsSection.params.splice(sessionIndex, 1);

                        // Remove from all players' data
                        players.forEach(player => {
                            if (player.data.mentalSkills && player.data.mentalSkills[sessionId]) {
                                delete player.data.mentalSkills[sessionId];
                            }
                        });

                        renderLogForm();
                        populateForm(activePlayerId);
                        saveData();
                        showToast(`Session "${sessionName}" deleted.`);
                    }
                }
            };

            const handleExport = () => {
                if (!activePlayerId) {
                    showToast("Please select a player to export.");
                    return;
                }
                const player = players.find(p => p.id === activePlayerId);
                if (!player) return;

                const exportData = {
                    player: player,
                    structure: logStructure
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${player.name.replace(/\s+/g, '_')}_dynamics_log.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast(`Data for "${player.name}" exported.`);
            };

            const handleSaveAsPdf = () => {
                if (!activePlayerId) {
                    showToast("Please select a player to generate a PDF.");
                    return;
                }
                showToast("Generating PDF... Please wait.");
                const player = players.find(p => p.id === activePlayerId);
                
                // Temporarily make all elements visible for capture
                const { jsPDF } = window.jspdf;
                const contentToCapture = document.getElementById('pdf-content');
                const mainContentToCapture = document.getElementById('log-form');

                html2canvas(mainContentToCapture, { backgroundColor: '#111827', scale: 2 }).then(mainCanvas => {
                    html2canvas(contentToCapture, { backgroundColor: '#1f2937', scale: 2 }).then(headerCanvas => {
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const pageWidth = pdf.internal.pageSize.getWidth();
                        const pageHeight = pdf.internal.pageSize.getHeight();
                        
                        // Add header
                        const headerImgData = headerCanvas.toDataURL('image/png');
                        const headerImgProps = pdf.getImageProperties(headerImgData);
                        const headerPdfWidth = pageWidth - 20; // with margin
                        const headerPdfHeight = (headerImgProps.height * headerPdfWidth) / headerImgProps.width;
                        pdf.addImage(headerImgData, 'PNG', 10, 10, headerPdfWidth, headerPdfHeight);

                        // Add main content
                        const mainImgData = mainCanvas.toDataURL('image/png');
                        const mainImgProps = pdf.getImageProperties(mainImgData);
                        const mainPdfWidth = pageWidth - 20; // with margin
                        const mainPdfHeight = (mainImgProps.height * mainPdfWidth) / mainImgProps.width;

                        let currentHeight = headerPdfHeight + 20;
                        if (currentHeight + mainPdfHeight < pageHeight) {
                            pdf.addImage(mainImgData, 'PNG', 10, currentHeight, mainPdfWidth, mainPdfHeight);
                        } else {
                            pdf.addPage();
                            pdf.addImage(mainImgData, 'PNG', 10, 10, mainPdfWidth, mainPdfHeight);
                        }
                        
                        pdf.save(`${player.name.replace(/\s+/g, '_')}_Log_${new Date().toISOString().split('T')[0]}.pdf`);
                    });
                });
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        const importedPlayer = importedData.player || importedData;
                        const importedStructure = importedData.structure;

                        if (!importedPlayer.id || !importedPlayer.name || !importedPlayer.data) {
                           throw new Error("Invalid file format.");
                        }

                        if (importedStructure) {
                            const mentalSkillsSection = logStructure.find(s => s.type === 'mental_skills');
                            const importedMentalSkills = importedStructure.find(s => s.type === 'mental_skills');
                            
                            if (importedMentalSkills) {
                                importedMentalSkills.params.forEach(importedParam => {
                                    if (importedParam.isCustom && !mentalSkillsSection.params.some(p => p.id === importedParam.id)) {
                                        mentalSkillsSection.params.push(importedParam);
                                    }
                                });
                            }
                        }
                        
                        const existingPlayerIndex = players.findIndex(p => p.id === importedPlayer.id || p.name.toLowerCase() === importedPlayer.name.toLowerCase());
                        
                        if (existingPlayerIndex > -1) {
                           players[existingPlayerIndex] = importedPlayer;
                           showToast(`Player "${importedPlayer.name}" data updated.`);
                        } else {
                           players.push(importedPlayer);
                           showToast(`Player "${importedPlayer.name}" imported.`);
                        }
                        activePlayerId = importedPlayer.id;
                        
                        renderLogForm();
                        updateAndSave();

                    } catch (err) {
                        console.error("Import failed:", err);
                        showToast("Import failed. Please select a valid file.");
                    }
                    e.target.value = null;
                };
                reader.readAsText(file);
            };

            const handleReset = () => {
                if(activePlayerId){
                    const player = players.find(p => p.id === activePlayerId);
                    if(confirm(`Are you sure you want to clear all data for ${player.name}? This will reset all fields.`)){
                        player.data = generateNewLogData();
                        populateForm(activePlayerId);
                        saveData();
                        showToast(`Form for ${player.name} has been cleared.`);
                    }
                } else {
                    clearForm();
                    showToast("Form cleared.");
                }
            };
            
            // --- Initialization ---

            function updateAndSave() {
                updatePlayerDropdown();
                if (activePlayerId) {
                    populateForm(activePlayerId);
                } else {
                    clearForm();
                }
                saveData();
            }
            
            function init() {
                loadData();
                renderLogForm();
                updatePlayerDropdown();
                if(activePlayerId && players.some(p=>p.id === activePlayerId)) {
                    playerSelect.value = activePlayerId;
                } else if (players.length > 0) {
                    activePlayerId = players[0].id;
                    playerSelect.value = activePlayerId;
                } else {
                    activePlayerId = null;
                }
                
                if (activePlayerId) {
                    populateForm(activePlayerId);
                } else {
                    clearForm();
                }

                // Attach Event Listeners
                addPlayerBtn.addEventListener('click', handleAddPlayer);
                deletePlayerBtn.addEventListener('click', handleDeletePlayer);
                playerSelect.addEventListener('change', handlePlayerSelect);
                document.getElementById('dynamics-form').addEventListener('input', handleFormInput);
                document.getElementById('player-details-section').addEventListener('input', handleFormInput);
                exportBtn.addEventListener('click', handleExport);
                pdfBtn.addEventListener('click', handleSaveAsPdf);
                importFile.addEventListener('change', handleImport);
                resetBtn.addEventListener('click', handleReset);
                
                playerNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addPlayerBtn.click();
                    }
                });
            }
            
            init();

        });
    </script>
</body>
</html>

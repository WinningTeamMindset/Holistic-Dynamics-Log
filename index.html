<!DOCTYPE html>
<html lang="en" class="bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holistic Dynamics Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        input[type="file"] { display: none; }
        .table-container { overflow-x: auto; }
        table { width: 100%; min-width: 600px; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #2dd4bf; color: #111827; padding: 10px 20px; border-radius: 8px; z-index: 1000; opacity: 0; transition: opacity 0.5s, transform 0.5s; font-weight: 500; }
        .toast.show { opacity: 1; transform: translate(-50%, -10px); }
        .custom-checkbox { appearance: none; background-color: #374151; border: 1px solid #6b7280; border-radius: 4px; width: 1.5rem; height: 1.5rem; cursor: pointer; position: relative; display: inline-block; vertical-align: middle; }
        .custom-checkbox:checked { background-color: #14b8a6; border-color: #0d9488; }
        .custom-checkbox:checked::after { content: '✔'; position: absolute; color: white; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1rem; }
        
        /* Styles for PDF Generation */
        .pdf-prepare .hide-for-pdf { display: none !important; }
        .pdf-prepare body { background-color: white !important; }
        .pdf-prepare #app { max-width: 100% !important; }
        .pdf-prepare .bg-gray-900, .pdf-prepare .bg-gray-800 { background-color: white !important; }
        .pdf-prepare .text-gray-200, .pdf-prepare .text-gray-300, .pdf-prepare .text-gray-400, .pdf-prepare .text-white { color: black !important; }
        .pdf-prepare .border-gray-600, .pdf-prepare .border-gray-700 { border-color: #e0e0e0 !important; }
        .pdf-prepare .border-teal-500 { border-color: #14b8a6 !important; }
        .pdf-prepare .text-teal-400 { color: #14b8a6 !important; }
        .pdf-prepare header { box-shadow: none !important; }
        .pdf-prepare fieldset { page-break-inside: avoid; }

    </style>
</head>
<body class="text-gray-200 p-2 sm:p-4 md:p-6 lg:p-8 bg-gray-900">
    <div id="app" class="max-w-7xl mx-auto flex flex-col">
        <header class="bg-gray-800 rounded-lg p-4 mb-4 shadow-lg hide-for-pdf">
            <h1 class="text-2xl font-bold text-teal-400 mb-4 text-center sm:text-left">Holistic Dynamics Log</h1>
            <div id="player-details-section" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 mb-4 border-t border-gray-700 pt-4" style="display: none;">
                <div>
                    <label for="log-date" class="block text-sm font-medium text-gray-400">Date</label>
                    <input type="date" id="log-date" class="player-detail-input mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full focus:ring-2 focus:ring-teal-500 focus:outline-none">
                </div>
                <div>
                    <label for="player-dob" class="block text-sm font-medium text-gray-400">D.O.B.</label>
                    <input type="date" id="player-dob" class="player-detail-input mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full focus:ring-2 focus:ring-teal-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400">Age</label>
                    <span id="player-age" class="mt-1 flex items-center bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white w-full h-10"></span>
                </div>
                <div>
                    <label for="player-position" class="block text-sm font-medium text-gray-400">Position</label>
                    <input type="text" id="player-position" placeholder="e.g., Forward" class="player-detail-input mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full focus:ring-2 focus:ring-teal-500 focus:outline-none">
                </div>
                <div>
                    <label for="player-shirt-nr" class="block text-sm font-medium text-gray-400">Shirt Nr.</label>
                    <input type="number" id="player-shirt-nr" placeholder="e.g., 10" class="player-detail-input mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full focus:ring-2 focus:ring-teal-500 focus:outline-none">
                </div>
            </div>
            <div class="flex flex-col sm:flex-row items-center gap-2 mb-4 border-t border-gray-700 pt-4">
                <select id="player-select" class="bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:outline-none w-full sm:w-auto"></select>
                <input id="player-name-input" type="text" placeholder="New player name..." class="bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:outline-none flex-grow w-full">
                <button id="add-player-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 w-full sm:w-auto">Add Player</button>
                <button id="delete-player-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 w-full sm:w-auto">Delete Player</button>
            </div>
            <div class="flex flex-wrap gap-2 border-t border-gray-700 pt-4">
                <button id="reset-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 flex-1 sm:flex-grow-0">Clear for New Player</button>
                <button id="export-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 flex-1 sm:flex-grow-0">Export Player Data</button>
                <label for="import-file" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 cursor-pointer flex-1 sm:flex-grow-0 text-center">Import Player Data</label>
                <input type="file" id="import-file" accept=".json">
                <button id="pdf-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 flex-1 sm:flex-grow-0">Save as PDF</button>
            </div>
        </header>

        <main class="flex-grow bg-gray-800 rounded-lg p-4 shadow-inner">
            <form id="dynamics-form" onsubmit="return false;"></form>
        </main>
        
        <div id="toast" class="toast"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const playerSelect = document.getElementById('player-select');
            const playerNameInput = document.getElementById('player-name-input');
            const addPlayerBtn = document.getElementById('add-player-btn');
            const deletePlayerBtn = document.getElementById('delete-player-btn');
            const resetBtn = document.getElementById('reset-btn');
            const exportBtn = document.getElementById('export-btn');
            const importFile = document.getElementById('import-file');
            const dynamicsForm = document.getElementById('dynamics-form');
            const toastElement = document.getElementById('toast');
            const pdfBtn = document.getElementById('pdf-btn');
            const playerDetailsSection = document.getElementById('player-details-section');
            const logDateInput = document.getElementById('log-date');
            const playerDobInput = document.getElementById('player-dob');
            const playerAgeSpan = document.getElementById('player-age');
            const playerPositionInput = document.getElementById('player-position');
            const playerShirtNrInput = document.getElementById('player-shirt-nr');

            let players = [];
            let activePlayerId = null;

            const logStructure = [
                {
                    title: "SECTION 1: FOUNDATIONAL READINESS",
                    description: "This section is the foundation. It tells you if the athlete is physically and mentally prepared to train effectively before they even start.",
                    params: [
                        { id: 'sleep', label: 'Athlete-Reported Sleep', options: ['Optimal (8+ hrs)', 'Sufficient (7-8 hrs)', 'Compromised (<7 hrs)'] },
                        { id: 'readiness', label: 'Physiological Readiness', options: ['High', 'Moderate', 'Low'] },
                        { id: 'punctuality', label: 'Morning Punctuality', options: ['Proactive', 'Standard', 'Reactive'] },
                        { id: 'protocols', label: 'Adherence to Protocols', options: ['Diligent', 'Compliant', 'Avoidant'] }
                    ]
                },
                {
                    title: "SECTION 2: PSYCHOLOGICAL & BEHAVIORAL PROFILE",
                    description: "This is the athlete’s 'Operating System.' It reveals their default tendencies, social roles, and communication styles.",
                    params: [
                        { id: 'repSystem', label: 'Primary Representational System', options: ['Visual (Learns by seeing)', 'Auditory (Learns by hearing)', 'Kinesthetic (Learns by doing)'] },
                        { id: 'motivation', label: 'Primary Motivational Driver', options: ['Towards Pleasure', 'Away From Pain'] },
                        { id: 'validation', label: 'Source of Validation', options: ['Internal', 'External'] },
                        { id: 'leadershipStyle', label: 'Primary Leadership Style', options: ['Task-Leader', 'Social-Leader', 'Supporter', 'Challenger', 'Follower'] },
                        { id: 'commStyle', label: 'Dominant Communication Style', options: ['Direct & Honest', 'Supportive & Positive', 'Passive-Aggressive / Sarcastic', 'Quiet / Non-Verbal'] },
                        { id: 'conflictApproach', label: 'Approach to Conflict', options: ['Mediator', 'Confrontational', 'Avoidant', 'Escalator'] }
                    ]
                },
                {
                    title: "SECTION 3: TRAINING & PERFORMANCE DYNAMICS",
                    description: "This is the core of the observation. It logs how the athlete behaves and reacts within the training environment itself.",
                    params: [
                        { id: 'context', label: 'Context of Observation', options: ['Low-Pressure', 'Moderate-Pressure', 'High-Pressure'] },
                        { id: 'focus', label: 'Focus & Activation', options: ['Proactive', 'Standard', 'Distracted'] },
                        { id: 'personalErrorResponse', label: 'Reaction to Personal Error', options: ['Accountability', 'Frustration', 'Blame', 'Indifference'] },
                        { id: 'teammateErrorResponse', label: 'Reaction to Teammate\'s Error', options: ['Encouragement', 'Correction', 'Frustration', 'Ignoring'] },
                        { id: 'perseverance', label: 'Perseverance Under Fatigue', options: ['High & Consistent Effort', 'Fluctuating Effort', 'Gives Up / Avoids'] },
                        { id: 'language', label: 'Observed Dominant Language', options: ['Possibility-Focused', 'Problem-Focused'] }
                    ]
                },
                {
                    title: "SECTION 4: MATCH DAY PRESSURE RESPONSE (Optional)",
                    description: "This optional section assesses how the athlete handles the unique stress of competition.",
                    params: [
                         { id: 'preCompState', label: 'Pre-Competition State', options: ['Optimal Fighter', 'Anxious/Hyper-activated', 'Apathetic/Withdrawn'] },
                         { id: 'pressureResponse', label: 'Response to High-Pressure', options: ['Thrives', 'Copes', 'Hides/Panics'] },
                         { id: 'setbackBodyLanguage', label: 'Body Language After Setback', options: ['Resilient', 'Defeated', 'Agitated'] },
                         { id: 'postMatchReaction', label: 'Post-Match Reaction', options: ['Balanced', 'Highly Emotional', 'Destructive/Blaming'] }
                    ]
                },
                {
                    title: "SECTION 5: STRENGTHS & CORRECTIONS ASSESSMENT",
                    description: "A dual assessment identifying key strengths and areas for correction, from both the player's and coach's perspective.",
                    type: 'assessment_grid' // New type for custom rendering
                },
                {
                    title: "SECTION 6: MENTAL SKILLS & ACTION PLAN",
                    description: "Track and score the implementation of key mental skills and intervention sessions. This forms the player's action plan.",
                    type: 'mental_skills',
                    params: [
                        { id: 'selfTalk', label: 'Positive Self Talk' }, { id: 'negativeSelfTalk', label: 'Negative Self Talk' },
                        { id: 'emotionalAnchor', label: 'Emotional Anchor' }, { id: 'emotionalControl', label: 'Emotional Control' },
                        { id: 'visualisation', label: 'Visualisation' }, { id: 'goalSetting', label: 'Goal Setting' },
                        { id: 'stressControl', label: 'Stress Control' }, { id: 'selfAwareness', label: 'Self Awareness' },
                        { id: 'strengthCorrections', label: 'Strength & Corrections' }, { id: 'breathing', label: 'Breathing Techniques' },
                        { id: 'focus', label: 'How to Focus' }, { id: 'individualSessions', label: 'Individual Sessions' },
                        { id: 'crisisTalks', label: 'Crisis Talks' }, { id: 'newBehavior', label: 'New Behavior Pattern' },
                        { id: 'patternInterrupt', label: 'Pattern Interrupt' }
                    ]
                }
            ];

            const showToast = (message) => {
                toastElement.textContent = message;
                toastElement.classList.add('show');
                setTimeout(() => { toastElement.classList.remove('show'); }, 3000);
            };

            const calculateAge = (dobString) => {
                if (!dobString) return '';
                const dob = new Date(dobString);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) { age--; }
                return age >= 0 ? age : '';
            };

            const generateNewLogData = () => {
                const data = { logDate: new Date().toISOString().split('T')[0] };
                data.assessmentGrid = {};
                ['player_strength', 'player_correction', 'coach_strength', 'coach_correction'].forEach(type => {
                    for (let i = 1; i <= 5; i++) {
                        data.assessmentGrid[`${type}_${i}_text`] = '';
                        data.assessmentGrid[`${type}_${i}_score`] = '';
                    }
                });

                logStructure.forEach(section => {
                    if (section.type === 'mental_skills') {
                        data.mentalSkills = {};
                        section.params.forEach(param => { data.mentalSkills[param.id] = { checked: false, score: '', comment: '' }; });
                    } else if (section.type !== 'assessment_grid') {
                        if (!data['analyst-comments']) data['analyst-comments'] = {};
                        section.params.forEach(param => {
                            data[param.id] = '';
                            data['analyst-comments'][param.id] = '';
                        });
                    }
                });
                return data;
            };

            const saveData = () => {
                try {
                    localStorage.setItem('dynamicsLogPlayers', JSON.stringify(players));
                    localStorage.setItem('dynamicsLogActivePlayer', activePlayerId);
                    localStorage.setItem('dynamicsLogStructure', JSON.stringify(logStructure));
                } catch (e) {
                    console.error("Failed to save data:", e);
                    showToast("Error: Could not save data.");
                }
            };

            const loadData = () => {
                try {
                    const savedPlayers = localStorage.getItem('dynamicsLogPlayers');
                    const savedActivePlayer = localStorage.getItem('dynamicsLogActivePlayer');
                    // We don't load the structure anymore to ensure the code's structure is always used
                    if (savedPlayers) { players = JSON.parse(savedPlayers); }
                    if (savedActivePlayer) { activePlayerId = savedActivePlayer; }
                } catch (e) {
                    console.error("Failed to load data:", e);
                    players = []; activePlayerId = null; showToast("Error: Could not load data.");
                }
            };

            const renderLogForm = () => {
                let html = '';
                const scoreOptions = `<option value="">N/A</option>${[...Array(10).keys()].map(i => `<option value="${i + 1}">${i + 1}</option>`).join('')}`;

                logStructure.forEach((section, index) => {
                    html += `<fieldset id="fieldset-section-${index}" class="mb-6 border-t-2 border-teal-500 pt-2"><legend class="text-xl font-semibold text-teal-400 mb-2 px-2">${section.title}</legend><p class="text-sm text-gray-400 mb-4 px-2">${section.description}</p><div class="table-container">`;
                    
                    if (section.type === 'assessment_grid') {
                        const createGrid = (type, title) => {
                            let gridHtml = `<h3 class="text-lg font-medium text-gray-300 mt-4 mb-2 px-2">${title}</h3>`;
                            gridHtml += `<table class="min-w-full divide-y divide-gray-700"><thead class="bg-gray-700/50"><tr><th class="w-12 px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">#</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">${type.includes('strength') ? 'Strength' : 'Correction'}</th><th class="w-40 px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Score (1-10)</th></tr></thead><tbody class="bg-gray-800 divide-y divide-gray-700">`;
                            for (let i = 1; i <= 5; i++) {
                                gridHtml += `<tr>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${i}</td>
                                    <td class="px-4 py-4"><input type="text" data-id="${type}_${i}_text" class="log-input bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full focus:ring-2 focus:ring-teal-500 focus:outline-none"></td>
                                    <td class="px-4 py-4"><select data-id="${type}_${i}_score" class="log-input bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full focus:ring-2 focus:ring-teal-500 focus:outline-none">${scoreOptions}</select></td>
                                </tr>`;
                            }
                            gridHtml += '</tbody></table>';
                            return gridHtml;
                        };
                        html += createGrid('player_strength', "Player's Self-Assessment: 5 Strengths");
                        html += createGrid('player_correction', "Player's Self-Assessment: 5 Corrections");
                        html += createGrid('coach_strength', "Coach's Assessment: 5 Strengths");
                        html += createGrid('coach_correction', "Coach's Assessment: 5 Corrections");

                    } else if (section.type === 'mental_skills') {
                        html += `<table class="min-w-full divide-y divide-gray-700"><thead class="bg-gray-700/50"><tr><th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Session</th><th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Re-Do</th><th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Success Rate (1-10)</th><th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Comments</th></tr></thead><tbody class="bg-gray-800 divide-y divide-gray-700">`;
                        section.params.forEach(param => { html += `<tr><td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${param.label}</td><td class="px-4 py-4 whitespace-nowrap text-center"><input type="checkbox" data-id="${param.id}" data-subtype="checked" class="log-input custom-checkbox"></td><td class="px-4 py-4 whitespace-nowrap"><select data-id="${param.id}" data-subtype="score" class="log-input bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full focus:ring-2 focus:ring-teal-500 focus:outline-none">${scoreOptions}</select></td><td class="px-4 py-4"><textarea data-id="${param.id}" data-subtype="comment" class="log-input bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full h-16 resize-y focus:ring-2 focus:ring-teal-500 focus:outline-none" placeholder="Specifics..."></textarea></td></tr>`; });
                        html += `</tbody></table><div class="mt-4 p-4 border-t border-gray-700 flex flex-col sm:flex-row gap-2 hide-on-print"><input id="new-session-input" type="text" placeholder="New session name..." class="bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:outline-none flex-grow"><button id="add-session-btn" type="button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">Add New Session</button></div>`;
                    } else {
                        html += `<table class="min-w-full divide-y divide-gray-700"><thead class="bg-gray-700/50"><tr><th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Parameter</th><th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Observation / Selection</th><th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Analyst Comments</th></tr></thead><tbody class="bg-gray-800 divide-y divide-gray-700">`;
                        section.params.forEach(param => { html += `<tr><td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${param.label}</td><td class="px-4 py-4 whitespace-nowrap"><select data-id="${param.id}" class="log-input bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full focus:ring-2 focus:ring-teal-500 focus:outline-none"><option value="">-- Select --</option>${param.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}</select></td><td class="px-4 py-4"><textarea data-id="${param.id}" data-type="comment" class="log-input bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white w-full h-16 resize-y focus:ring-2 focus:ring-teal-500 focus:outline-none" placeholder="Specific examples..."></textarea></td></tr>`; });
                        html += `</tbody></table>`;
                    }
                    html += `</div></fieldset>`;
                });
                dynamicsForm.innerHTML = html;
                document.getElementById('add-session-btn')?.addEventListener('click', handleAddSession);
            };

            const updatePlayerDropdown = () => {
                const currentVal = playerSelect.value;
                playerSelect.innerHTML = '<option value="">-- Select a Player --</option>';
                players.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.name} ${p.shirtNumber ? `(#${p.shirtNumber})` : ''}`;
                    playerSelect.appendChild(option);
                });
                playerSelect.value = currentVal;
            };

            const populateForm = (playerId) => {
                const player = players.find(p => p.id === playerId);
                if (!player) { clearForm(); return; }
                const defaultData = generateNewLogData();
                player.data = { ...defaultData, ...player.data };
                player.data.assessmentGrid = { ...defaultData.assessmentGrid, ...player.data.assessmentGrid };
                player.data.mentalSkills = { ...defaultData.mentalSkills, ...player.data.mentalSkills };
                player.data['analyst-comments'] = { ...defaultData['analyst-comments'], ...player.data['analyst-comments'] };

                playerDetailsSection.style.display = 'grid';
                logDateInput.value = player.data.logDate || new Date().toISOString().split('T')[0];
                playerDobInput.value = player.dob || '';
                playerAgeSpan.textContent = calculateAge(player.dob);
                playerPositionInput.value = player.position || '';
                playerShirtNrInput.value = player.shirtNumber || '';
                
                document.querySelectorAll('.log-input').forEach(input => {
                    const dataId = input.dataset.id;
                    const subtype = input.dataset.subtype;

                    if (player.data.assessmentGrid && dataId in player.data.assessmentGrid) {
                        input.value = player.data.assessmentGrid[dataId] || '';
                    } else if (subtype) { // Mental Skills
                        if (player.data.mentalSkills && player.data.mentalSkills[dataId]) {
                            if (subtype === 'checked') input.checked = player.data.mentalSkills[dataId].checked || false;
                            else input.value = player.data.mentalSkills[dataId].score || '';
                        }
                    } else if (input.dataset.type === 'comment') { // Standard Analyst Comments
                        if (player.data['analyst-comments']) input.value = player.data['analyst-comments'][dataId] || '';
                    } else { // Standard Select
                        input.value = player.data[dataId] || '';
                    }
                });
            };

            const clearForm = () => {
                dynamicsForm.reset();
                playerDetailsSection.style.display = 'none';
                logDateInput.value = '';
                playerDobInput.value = '';
                playerAgeSpan.textContent = '';
                playerPositionInput.value = '';
                playerShirtNrInput.value = '';
            };
            
            const handleAddPlayer = () => {
                const name = playerNameInput.value.trim();
                if (!name) { showToast("Please enter a player name."); return; }
                if (players.some(p => p.name.toLowerCase() === name.toLowerCase())) { showToast("A player with this name already exists."); return; }
                const newPlayer = { id: `player_${Date.now()}`, name: name, data: generateNewLogData() };
                players.push(newPlayer);
                activePlayerId = newPlayer.id;
                playerNameInput.value = '';
                updateAndSave();
                showToast(`Player "${name}" added.`);
            };

            const handleDeletePlayer = () => {
                if (!activePlayerId) { showToast("No player selected to delete."); return; }
                const playerIndex = players.findIndex(p => p.id === activePlayerId);
                if (playerIndex > -1) {
                    if (confirm(`Are you sure you want to delete player: ${players[playerIndex].name}?`)) {
                        const playerName = players[playerIndex].name;
                        players.splice(playerIndex, 1);
                        const newIndex = Math.max(0, playerIndex - 1);
                        activePlayerId = players.length > 0 ? players[newIndex].id : null;
                        updateAndSave();
                        showToast(`Player "${playerName}" deleted.`);
                    }
                }
            };
            
            const handlePlayerSelect = (e) => {
                activePlayerId = e.target.value;
                if (activePlayerId) { populateForm(activePlayerId); } 
                else { clearForm(); }
                saveData();
            };

            const handleFormInput = (e) => {
                if (!activePlayerId) return;
                const player = players.find(p => p.id === activePlayerId);
                if (!player) return;
                
                const dataId = e.target.dataset.id;

                if (e.target.classList.contains('player-detail-input')) {
                    const id = e.target.id;
                    if (id === 'log-date') player.data.logDate = e.target.value;
                    else if (id === 'player-dob') { player.dob = e.target.value; playerAgeSpan.textContent = calculateAge(player.dob); }
                    else if (id === 'player-position') player.position = e.target.value;
                    else if (id === 'player-shirt-nr') { player.shirtNumber = e.target.value; updatePlayerDropdown(); }
                } else if (player.data.assessmentGrid && dataId in player.data.assessmentGrid) {
                    player.data.assessmentGrid[dataId] = e.target.value;
                } else {
                    const subtype = e.target.dataset.subtype;
                    if (subtype) {
                        if (!player.data.mentalSkills[dataId]) player.data.mentalSkills[dataId] = { checked: false, score: '', comment: '' };
                        if(subtype === 'checked') player.data.mentalSkills[dataId].checked = e.target.checked;
                        if(subtype === 'score') player.data.mentalSkills[dataId].score = e.target.value;
                        if(subtype === 'comment') player.data.mentalSkills[dataId].comment = e.target.value;
                    } else if (e.target.dataset.type === 'comment') {
                        player.data['analyst-comments'][dataId] = e.target.value;
                    } else {
                        player.data[dataId] = e.target.value;
                    }
                }
                saveData();
            };
            
            const handleAddSession = () => {
                const newSessionInput = document.getElementById('new-session-input');
                const sessionName = newSessionInput.value.trim();
                if (!sessionName) { showToast("Please enter a name for the new session."); return; }
                const sessionId = sessionName.toLowerCase().replace(/\s+/g, '_') + `_${Date.now()}`;
                const mentalSkillsSection = logStructure.find(s => s.type === 'mental_skills');
                if (mentalSkillsSection.params.some(p => p.label.toLowerCase() === sessionName.toLowerCase())) { showToast("This session already exists."); return; }
                mentalSkillsSection.params.push({ id: sessionId, label: sessionName });
                players.forEach(player => {
                    if (!player.data.mentalSkills) player.data.mentalSkills = {};
                    player.data.mentalSkills[sessionId] = { checked: false, score: '', comment: '' };
                });
                newSessionInput.value = '';
                renderLogForm();
                if (activePlayerId) populateForm(activePlayerId);
                saveData();
                showToast(`Session "${sessionName}" added.`);
            };

            const handleExport = () => {
                if (!activePlayerId) { showToast("Please select a player to export."); return; }
                const player = players.find(p => p.id === activePlayerId);
                if (!player) return;
                const exportData = { player: player };
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `${player.name.replace(/\s+/g, '_')}_dynamics_log.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                showToast(`Data for "${player.name}" exported.`);
            };

            const handleImport = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        const importedPlayer = importedData.player || importedData;
                        if (!importedPlayer.id || !importedPlayer.name || !importedPlayer.data) { throw new Error("Invalid file format."); }
                        
                        const existingPlayerIndex = players.findIndex(p => p.id === importedPlayer.id || p.name.toLowerCase() === importedPlayer.name.toLowerCase());
                        if (existingPlayerIndex > -1) { players[existingPlayerIndex] = importedPlayer; showToast(`Player "${importedPlayer.name}" data updated.`); } 
                        else { players.push(importedPlayer); showToast(`Player "${importedPlayer.name}" imported.`); }
                        activePlayerId = importedPlayer.id;
                        updateAndSave();
                    } catch (err) { console.error("Import failed:", err); showToast("Import failed. Please select a valid file."); }
                    e.target.value = null;
                };
                reader.readAsText(file);
            };

            const handleSaveAsPdf = async () => {
                if (!activePlayerId) { showToast("Please select a player to generate a PDF."); return; }
                const player = players.find(p => p.id === activePlayerId);
                if (!player) return;

                showToast("Generating PDF...");
                
                document.body.classList.add('pdf-prepare');

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageMargin = 15;
                const contentWidth = pdf.internal.pageSize.getWidth() - (pageMargin * 2);
                let currentY = pageMargin;

                const addElementToPdf = async (element) => {
                    if (!element) return;
                    const canvas = await html2canvas(element, { 
                        scale: 2, 
                        logging: false,
                        backgroundColor: null
                    });
                    const imgData = canvas.toDataURL('image/png');
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfHeight = (imgProps.height * contentWidth) / imgProps.width;
                    
                    if (currentY + pdfHeight > pdf.internal.pageSize.getHeight() - pageMargin) {
                        pdf.addPage();
                        currentY = pageMargin;
                    }
                    pdf.addImage(imgData, 'PNG', pageMargin, currentY, contentWidth, pdfHeight);
                    currentY += pdfHeight + 5;
                };
                
                pdf.setFont('Inter', 'bold');
                pdf.setFontSize(18);
                pdf.setTextColor('#14b8a6');
                pdf.text('Holistic Dynamics Log', pageMargin, currentY);
                currentY += 8;

                pdf.setFont('Inter', 'normal');
                pdf.setFontSize(12);
                pdf.setTextColor('#000000');
                pdf.text(`Player: ${player.name} ${player.shirtNumber ? `(#${player.shirtNumber})` : ''} | Position: ${player.position || 'N/A'}`, pageMargin, currentY);
                currentY += 6;
                pdf.text(`Log Date: ${logDateInput.value} | D.O.B: ${player.dob || 'N/A'} (Age: ${playerAgeSpan.textContent || 'N/A'})`, pageMargin, currentY);
                currentY += 10;
                pdf.setDrawColor('#e0e0e0');
                pdf.line(pageMargin, currentY - 5, contentWidth + pageMargin, currentY - 5);

                const allSections = document.querySelectorAll('#dynamics-form fieldset');
                for (const section of allSections) {
                    await addElementToPdf(section);
                }

                pdf.save(`${player.name.replace(/\s+/g, '_')}_Log.pdf`);
                document.body.classList.remove('pdf-prepare');
                showToast("PDF saved successfully.");
            };

            const handleReset = () => {
                playerSelect.value = ""; activePlayerId = null;
                playerNameInput.value = "";
                clearForm();
                updateAndSave();
                showToast("Form cleared for new player.");
            };
            
            function updateAndSave() {
                updatePlayerDropdown();
                if (activePlayerId) { populateForm(activePlayerId); } 
                else { clearForm(); }
                saveData();
            }
            
            function init() {
                loadData();
                renderLogForm();
                updateAndSave();
                
                addPlayerBtn.addEventListener('click', handleAddPlayer);
                deletePlayerBtn.addEventListener('click', handleDeletePlayer);
                playerSelect.addEventListener('change', handlePlayerSelect);
                dynamicsForm.addEventListener('input', handleFormInput);
                playerDetailsSection.addEventListener('input', handleFormInput);
                exportBtn.addEventListener('click', handleExport);
                importFile.addEventListener('change', handleImport);
                resetBtn.addEventListener('click', handleReset);
                pdfBtn.addEventListener('click', handleSaveAsPdf);
                playerNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); addPlayerBtn.click(); }
                });
            }

            init();
        });
    </script>
</body>
</html>
